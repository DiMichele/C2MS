# ==============================================================================
# SUGECO - Security Configuration
# ==============================================================================
# Questo file implementa misure di sicurezza a livello Apache per proteggere
# l'applicazione da vulnerabilità comuni.
# ==============================================================================

# Disabilita la visualizzazione del contenuto delle directory
Options -Indexes

# Disabilita l'esecuzione di script CGI in questa directory
Options -ExecCGI

# Disabilita il seguire i link simbolici (previene alcuni attacchi)
Options -FollowSymLinks
Options +SymLinksIfOwnerMatch

# ==============================================================================
# BLOCCO ACCESSO A FILE SENSIBILI
# ==============================================================================

# Blocca accesso a file di configurazione e sensibili
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.(env|htaccess|htpasswd|ini|log|sh|sql|bak|config|dist|fla|psd|swp|json|lock|md)$">
    Require all denied
</FilesMatch>

# Blocca accesso a file PHP nella root (eccetto quelli necessari)
<FilesMatch "^(?!index\.php).*\.php$">
    Require all denied
</FilesMatch>

# Blocca accesso diretto al file artisan
<Files "artisan">
    Require all denied
</Files>

# NOTA: La protezione delle directory sensibili (vendor, storage, etc.)
# è gestita tramite file .htaccess specifici in quelle directory
# e tramite il routing Laravel che non espone queste directory

# ==============================================================================
# PROTEZIONE DA ATTACCHI COMUNI
# ==============================================================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # ==============================================================================
    # BLOCCO ACCESSO A ENDPOINT APACHE SENSIBILI
    # ==============================================================================
    
    # Blocca /server-status (CVE - Information Disclosure)
    RewriteRule ^server-status - [F,L]
    
    # Blocca /server-info (CVE - Information Disclosure)  
    RewriteRule ^server-info - [F,L]
    
    # Blocca accesso a script CGI
    RewriteRule ^cgi-bin/ - [F,L]
    RewriteRule \.cgi$ - [F,L]
    RewriteRule \.pl$ - [F,L]
    
    # Blocca accesso a phpinfo
    RewriteRule ^phpinfo\.php$ - [F,L]
    
    # ==============================================================================
    # PROTEZIONE DA HOST HEADER INJECTION
    # ==============================================================================
    
    # Blocca richieste con Host header manipolato (protegge da VirtualHost exploit)
    # Permette solo localhost, IP locali e domini configurati
    RewriteCond %{HTTP_HOST} !^localhost$ [NC]
    RewriteCond %{HTTP_HOST} !^127\.0\.0\.1$ [NC]
    RewriteCond %{HTTP_HOST} !^192\.168\.[0-9]+\.[0-9]+$ [NC]
    RewriteCond %{HTTP_HOST} !^10\.[0-9]+\.[0-9]+\.[0-9]+$ [NC]
    RewriteCond %{HTTP_HOST} !^172\.(1[6-9]|2[0-9]|3[0-1])\.[0-9]+\.[0-9]+$ [NC]
    RewriteCond %{HTTP_HOST} !\.ngrok\.io$ [NC]
    RewriteCond %{HTTP_HOST} !\.ngrok-free\.app$ [NC]
    RewriteCond %{HTTP_HOST} !\.ngrok-free\.dev$ [NC]
    RewriteCond %{HTTP_HOST} !\.trycloudflare\.com$ [NC]
    RewriteCond %{HTTP_HOST} !^%{SERVER_NAME}$ [NC]
    RewriteRule ^ - [F,L]
    
    # ==============================================================================
    # PROTEZIONE DA METODI HTTP NON SICURI
    # ==============================================================================
    
    # Blocca metodi HTTP non necessari (TRACE, TRACK possono essere usati per XST)
    RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|OPTIONS) [NC]
    RewriteRule ^ - [F,L]
    
    # ==============================================================================
    # PROTEZIONE DA URL INJECTION
    # ==============================================================================
    
    # Blocca tentativi di path traversal
    RewriteCond %{REQUEST_URI} \.\./ [NC]
    RewriteRule ^ - [F,L]
    
    # Blocca tentativi di null byte injection
    RewriteCond %{REQUEST_URI} %00 [NC]
    RewriteRule ^ - [F,L]
    
    # ==============================================================================
    # ROUTING LARAVEL
    # ==============================================================================
    
    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
    
    # Redirect Trailing Slashes If Not A Folder
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]
    
    # Send Requests To Front Controller
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ public/index.php [L]
</IfModule>

# ==============================================================================
# SECURITY HEADERS (livello Apache)
# ==============================================================================

<IfModule mod_headers.c>
    # Previene clickjacking
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Previene MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Abilita protezione XSS
    Header always set X-XSS-Protection "1; mode=block"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Rimuove header che espongono informazioni sul server
    Header unset X-Powered-By
    Header unset Server
    
    # Previene che il contenuto venga interpretato come diverso dal dichiarato
    Header always set X-Download-Options "noopen"
    
    # Permessi browser
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()"
</IfModule>

# ==============================================================================
# FALLBACK SE MOD_REWRITE NON È DISPONIBILE
# ==============================================================================

<IfModule !mod_rewrite.c>
    RedirectMatch ^/(.*)$ public/index.php
</IfModule>

# ==============================================================================
# COMPRESSIONE (migliora performance)
# ==============================================================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

# ==============================================================================
# CACHE CONTROL PER RISORSE STATICHE
# ==============================================================================

<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType application/x-font-ttf "access plus 1 year"
</IfModule>
